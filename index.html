<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>내 뮤직 플레이어</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1e1e">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<style>
/* --- 기존 CSS 그대로 --- */
:root{--bg-color:#121212;--surface-color:#1e1e1e;--primary-color:#bb86fc;--secondary-color:#03dac6;--text-color:#e0e0e0;--subtle-text-color:#888;--border-color:#333;--danger-color:#cf6679;}
html{box-sizing:border-box;}*,*:before,*:after{box-sizing:inherit;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-color);padding:15px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
.app-container{width:100%;max-width:500px;background-color:var(--surface-color);border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:20px;overflow:hidden;}
header h1{text-align:center;font-size:24px;color:var(--primary-color);margin:0 0 20px 0;}
.input-section{display:flex;gap:10px;margin-bottom:20px;}
#youtubeUrl{flex-grow:1;min-width:0;background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:12px;padding:12px;font-size:14px;color:var(--text-color);}
#youtubeUrl:focus{outline:none;border-color:var(--primary-color);}
#addBtn{flex-shrink:0;padding:0 20px;font-size:14px;font-weight:600;border:none;border-radius:12px;cursor:pointer;color:#121212;background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));touch-action:manipulation;}
#addBtn:disabled{background:var(--border-color);color:var(--subtle-text-color);cursor:not-allowed;}
.player-section { margin-bottom: 20px; text-align: center; }
.album-art-section { width: 100%; max-width: 250px; margin: 0 auto 15px auto; aspect-ratio:1/1; background-color:#000; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
#albumArt { width: 100%; height: 100%; object-fit:cover; }
#nowPlaying { font-size:16px; font-weight:500; color: var(--text-color); margin-bottom:5px; height:22px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
#nowPlayingChannel { font-size:14px; color: var(--subtle-text-color); height:20px; margin-bottom:15px; }
audio { width: 100%; }

.playlist-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:0 5px;flex-wrap:wrap;gap:10px;}
.playlist-controls label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;}
.control-buttons{display:flex;gap:10px;}
.control-buttons button{background:none;border:1px solid var(--border-color);color:var(--subtle-text-color);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;}
.control-buttons button.danger{border-color:var(--danger-color);color:var(--danger-color);}
#playlist{list-style:none;padding:0;margin:0;max-height:calc(100vh - 600px);min-height:100px;overflow-y:auto;}
#playlist li{display:flex;align-items:center;gap:15px;padding:10px;border-radius:10px;cursor:pointer;transition:background-color .2s;}
#playlist li.playing { background-color: rgba(187, 134, 252, 0.1); }
#playlist li:hover{background-color:rgba(255,255,255,.05);}
.thumbnail{width:50px;height:50px;border-radius:6px;object-fit:cover;flex-shrink:0;}
.video-info{flex-grow:1;overflow:hidden;}
.video-info .title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 0 4px 0;}
.video-info .channel{font-size:12px;color:var(--subtle-text-color);margin:0;}
input[type=checkbox]{appearance:none;-webkit-appearance:none;width:20px;height:20px;border:2px solid var(--subtle-text-color);border-radius:6px;cursor:pointer;position:relative;flex-shrink:0;}
input[type=checkbox]:checked{background-color:var(--primary-color);border-color:var(--primary-color);}
input[type=checkbox]:checked::after{content:'✔';color:var(--surface-color);position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:14px;}
</style>
</head>
<body>
<div class="app-container">
    <header><h1>내 뮤직 플레이어</h1></header>
    <main>
        <div class="input-section">
            <input type="text" id="youtubeUrl" placeholder="유튜브 링크 붙여넣기">
            <button id="addBtn">추가</button>
        </div>
        <div class="player-section">
            <div class="album-art-section">
                <img id="albumArt" src="" alt="앨범 아트">
            </div>
            <p id="nowPlaying">재생할 음악을 선택하세요.</p>
            <p id="nowPlayingChannel"></p>
            <audio id="mediaPlayer" controls controlslist="nodownload" crossOrigin="anonymous"></audio>
        </div>
        <div class="playlist-section">
            <div class="playlist-controls">
                <label><input type="checkbox" id="selectAllCheckbox"><span>전체 선택</span></label>
                <div class="control-buttons">
                    <button id="deleteSelectedBtn">선택 삭제</button>
                    <button id="clearAllBtn" class="danger">전체 삭제</button>
                </div>
            </div>
            <ul id="playlist"></ul>
        </div>
    </main>
</div>

<script>
if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
        navigator.serviceWorker.register('/sw.js')
        .then(reg=>console.log('서비스 워커 등록 성공:',reg))
        .catch(err=>console.log('서비스 워커 등록 실패:',err));
    });
}
</script>

<script>
/* ○○○○○ music-player.js 시작 ○○○○○ */
const urlInput=document.getElementById('youtubeUrl'),
      addBtn=document.getElementById('addBtn'),
      mediaPlayer=document.getElementById('mediaPlayer'),
      nowPlaying=document.getElementById('nowPlaying'),
      nowPlayingChannel=document.getElementById('nowPlayingChannel'),
      albumArt=document.getElementById('albumArt'),
      playlistElement=document.getElementById('playlist'),
      selectAllCheckbox=document.getElementById('selectAllCheckbox'),
      deleteSelectedBtn=document.getElementById('deleteSelectedBtn'),
      clearAllBtn=document.getElementById('clearAllBtn');

const BACKEND_URL = "https://youtube-xi-khaki.vercel.app/api/youtube";

let playlist=[], currentPlayingIndex=-1;

window.addEventListener('load', loadPlaylist);
addBtn.addEventListener('click', addVideo);
deleteSelectedBtn.addEventListener('click', deleteSelected);
clearAllBtn.addEventListener('click', clearAll);
selectAllCheckbox.addEventListener('change', toggleSelectAll);
mediaPlayer.addEventListener('ended', playNext);

function loadPlaylist(){
    const data = localStorage.getItem('playlist');
    if(data) playlist = JSON.parse(data);
    renderPlaylist();
}

function savePlaylist(){
    localStorage.setItem('playlist', JSON.stringify(playlist));
}

function renderPlaylist(){
    playlistElement.innerHTML='';
    if(playlist.length===0){
        playlistElement.innerHTML=`<li style="justify-content:center;color:var(--subtle-text-color);">재생 목록이 비어있습니다.</li>`;
        selectAllCheckbox.checked=false;
        selectAllCheckbox.indeterminate=false;
        return;
    }
    playlist.forEach((video,index)=>{
        const li=document.createElement('li');
        if(index===currentPlayingIndex) li.classList.add('playing');
        li.innerHTML=`
            <input type="checkbox" data-index="${index}">
            <img src="${video.thumbnail}" class="thumbnail">
            <div class="video-info">
                <p class="title">${video.title}</p>
                <p class="channel">${video.channel}</p>
            </div>
        `;
        li.addEventListener('click',(e)=>{
            if(e.target.tagName!=='INPUT') playVideo(index);
        });
        playlistElement.appendChild(li);
    });
    updateSelectAllCheckbox();
}

async function addVideo(){
    const url = urlInput.value.trim();
    if(!url) return alert("URL을 입력하세요.");
    addBtn.disabled = true;
    try{
        const res = await fetch(`${BACKEND_URL}?url=${encodeURIComponent(url)}`);
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        playlist.push(data);
        savePlaylist();
        renderPlaylist();
        if(currentPlayingIndex===-1) playVideo(playlist.length-1);
        urlInput.value='';
    }catch(err){
        console.error(err);
        alert("비디오 정보를 가져오는데 실패했습니다.");
    }finally{
        addBtn.disabled=false;
    }
}

function playVideo(index){
    const video = playlist[index];
    if(!video) return;
    mediaPlayer.src = video.streamUrl;
    mediaPlayer.play();
    nowPlaying.textContent = video.title;
    nowPlayingChannel.textContent = video.channel;
    albumArt.src = video.thumbnail;
    currentPlayingIndex=index;
    renderPlaylist();
}

function playNext(){
    if(currentPlayingIndex+1 < playlist.length){
        playVideo(currentPlayingIndex+1);
    }
}

function deleteSelected(){
    const checked = Array.from(playlistElement.querySelectorAll('input[type=checkbox]:checked'))
                        .map(input=>parseInt(input.dataset.index));
    playlist = playlist.filter((_,i)=>!checked.includes(i));
    if(currentPlayingIndex>=playlist.length) currentPlayingIndex=-1;
    savePlaylist();
    renderPlaylist();
}

function clearAll(){
    if(confirm("정말 전체 삭제하시겠습니까?")){
        playlist=[];
        currentPlayingIndex=-1;
        savePlaylist();
        renderPlaylist();
    }
}

function toggleSelectAll(){
    const checked = selectAllCheckbox.checked;
    playlistElement.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=checked);
}

function updateSelectAllCheckbox(){
    const all = playlistElement.querySelectorAll('input[type=checkbox]');
    const checked = playlistElement.querySelectorAll('input[type=checkbox]:checked');
    selectAllCheckbox.checked = all.length===checked.length && all.length>0;
    selectAllCheckbox.indeterminate = checked.length>0 && checked.length<all.length;
}
/* ○○○○○ music-player.js 종료 ○○○○○ */
</script>
</body>
</html>
